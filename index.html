<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Luyện đọc cho học sinh lớp 2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
  <script type="importmap">
{
  "imports": {
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.26.0"
  }
}
</script>
</head>
  <body class="bg-blue-50">
    <div id="root"></div>
    <script type="module">
if (typeof process === 'undefined') {
  window.process = { env: {} };
}
import React, { useState, useRef, useCallback, useEffect } from 'react';
import ReactDOM from 'react-dom/client';
import { GoogleGenAI, Type, Modality } from "@google/genai";

// --- START OF types.ts ---
// All interfaces and types are defined here. No exports needed in a single file.

// --- END OF types.ts ---


// --- START OF constants.ts ---

const READING_PASSAGES = [
    { id: 1, title: "Bài 1: Tôi là học sinh lớp 2", content: "Ngày khai trường đã đến. Sáng sớm, mẹ mới gọi một câu mà tôi đã vùng dậy, khác hẳn mọi ngày. Tôi loáng một cái là xong hết mọi việc. Nhưng gần đến giờ đi, tôi lại thấy lo. Tôi nói với mẹ:\n- Con không đi học đâu.\n- Sao thế con?\n- Con sợ lắm. Con không quen ai ở trường.\nMẹ dịu dàng:\n- Đừng lo, con sẽ quen ngay thôi. Ở trường vui lắm.\nThấy tôi vẫn chưa hết lo, mẹ nói:\n- Trường mới của con ngay gần trường mầm non, con còn lạ gì nữa.\nNghe mẹ nói, tôi yên tâm hơn. Cùng mẹ đi trên con đường quen thuộc, tôi chợt thấy cảnh vật hôm nay khác hẳn. Tôi cũng không còn cảm giác sợ hãi. Thay vào đó là lòng háo hức, mong chờ." },
    { id: 2, title: "Bài 2: Bạn của Na", content: "Ở lớp, Na cũng có những người bạn tốt. Bạn nào cũng đáng yêu. Nhưng Na chỉ thân nhất với Lan. Lan học giỏi và rất tốt bụng. Giờ ra chơi, Na thường cùng Lan đọc sách hoặc chơi nhảy dây. Có chuyện gì, Na cũng tâm sự với Lan. Ngược lại, Lan cũng chia sẻ với Na mọi điều. Tình bạn của hai bạn thật đẹp." },
    { id: 3, title: "Bài 3: Cái trống trường em", content: "Cái trống trường em\nMùa hè cũng nghỉ\nSuốt ba tháng liền\nTrống nằm ngẫm nghĩ\nBuồn không hả trống?\n\nTrong những ngày hè\nBọn mình đi vắng\nChỉ còn tiếng ve\nSầu kêu trong nắng?\n\nCái trống lặng im\nNghiêng đầu trên giá\nChắc thấy chúng em\nNó mừng vui quá!\n\nKia trống đang gọi\nTùng! Tùng! Tùng! Tùng!\nVào năm học mới\nRộn ràng, tưng bừng." },
    { id: 4, title: "Bài 4: Làm bạn với bố", content: "Bố còn là một người bạn của tôi. Bố cùng tôi đá bóng, cùng tôi học bài. Bố còn có thể ngồi hàng giờ nghe tôi kể đủ thứ chuyện trên đời. Tối nào, hai bố con cũng tâm sự với nhau. Tôi yêu bố và tự hào về bố. Bố đúng là một người bạn lớn của tôi." },
    { id: 5, title: "Bài 5: Cây bàng", content: "Sân trường em có một cây bàng già. Từ xa nhìn lại, cây bàng như một chiếc ô xanh khổng lồ. Mùa xuân, lá bàng non mới nảy trông như những ngọn lửa xanh. Sang hè, lá lên thật dày, ánh sáng xuyên qua cũng xanh. Mùa thu, lá bàng ngả màu vàng úa rồi từ từ rụng xuống. Đến mùa đông, cây bàng khẳng khiu, trụi lá, trông như một bức tranh khắc khổ. Em rất yêu cây bàng vì nó cho chúng em bóng mát để vui chơi." },
    { id: 6, title: "Bài 6: Con lợn đất", content: "Mẹ mua cho em một con lợn đất. Con lợn dài chừng một gang tay, béo tròn trùng trục. Toàn thân nó được sơn một màu hồng tươi. Hai tai vểnh lên, hai mắt đen láy như hai hạt nhãn. Cái mõm chũm chĩm như đang cười. Hằng ngày, em đều dành dụm tiền ăn sáng để “nuôi” lợn. Em mong lợn mau “lớn” để em có tiền mua quà sinh nhật tặng mẹ." },
    { id: 7, title: "Bài 7: Bà em", content: "Bà em đã ngoài sáu mươi tuổi, mái tóc bà đã điểm bạc. Hằng ngày, bà kể cho em nghe những câu chuyện cổ tích hay và ý nghĩa. Bà còn dạy em làm những món đồ chơi bằng lá cây. Em rất yêu quý bà của em và mong bà luôn khỏe mạnh." },
    { id: 8, title: "Bài 8: Đi học", content: "Hương theo mẹ đi học trên con đường làng quen thuộc. Rặng cây ven đường lao xao trong gió. Dưới gốc cây, những chú gà con đang tíu tít tìm mồi. Xa xa, trên cánh đồng, những bác nông dân đang chăm chỉ làm việc. Hương thấy lòng mình vui sướng và yêu quê hương tha thiết." },
    { id: 9, title: "Bài 9: Cái nhãn vở", content: "Bố cho Giang một quyển vở mới. Giữa trang bìa là một chiếc nhãn vở trang trí rất đẹp. Giang lấy bút nắn nót viết tên trường, tên lớp, họ và tên của em vào nhãn vở. Bố nhìn những dòng chữ ngay ngắn, khen con gái đã tự viết được nhãn vở." },
    { id: 10, title: "Bài 10: Hoa sen", content: "Trong đầm gì đẹp bằng sen\nLá xanh, bông trắng, lại chen nhị vàng\nNhị vàng, bông trắng, lá xanh\nGần bùn mà chẳng hôi tanh mùi bùn." },
    { id: 11, title: "Bài 11: Chú gà con", content: "Chú gà con mới nở thật đáng yêu. Toàn thân chú được bao phủ bởi một lớp lông tơ màu vàng óng. Đôi mắt đen láy, tròn xoe. Cái mỏ nhỏ xinh, màu hồng nhạt. Đôi chân tí hon nhưng rất nhanh nhẹn. Chú lon ton chạy theo mẹ, miệng kêu “chíp chíp” không ngớt." },
    { id: 12, title: "Bài 12: Mưa", content: "Mưa! Mưa! Mưa! Những hạt mưa trong suốt, mát lạnh từ trên trời rơi xuống. Mưa nhảy múa trên những mái nhà. Mưa hát ca trên những tán lá cây. Mưa tưới mát cho vạn vật. Cây cối hân hoan đón nhận những giọt mưa. Sau cơn mưa, không khí trong lành, mát mẻ. Cầu vồng bảy sắc hiện ra, lung linh, huyền ảo." },
    { id: 13, title: "Bài 13: Sư tử và chuột nhắt", content: "Một con sư tử đang say ngủ, một chú chuột nhắt chạy ngang qua, leo lên đầu nó. Sư tử thức giấc, vươn móng vuốt, vồ lấy chuột. Chuột nhắt kêu la:\n- Xin ông tha cho! Tôi đâu cố ý làm ông thức giấc. Nếu ông tha, có ngày tôi sẽ báo đáp.\nSư tử cười, thả chuột ra. Ít lâu sau, sư tử bị sa lưới. Nó gầm lên mà không sao thoát được. Chuột nhắt nghe thấy, chạy lại, cắn đứt các mắt lưới, cứu sư tử. Sư tử lúc này mới thấy lời chuột nói là đúng." },
    { id: 14, title: "Bài 14: Đàn kiến", content: "Một đàn kiến đang đi trên đường thì gặp một dòng suối nhỏ. Cả đàn loay hoay tìm cách qua suối. Bỗng, một con kiến đầu đàn nghĩ ra một cách. Nó bảo cả đàn ôm lấy nhau, kết thành một chiếc bè. Thế là cả đàn kiến cùng nhau vượt qua dòng suối một cách an toàn. Câu chuyện cho thấy sức mạnh của sự đoàn kết." },
    { id: 15, title: "Bài 15: Cái bút chì", content: "Tôi là một cây bút chì. Tôi được làm từ gỗ và than chì. Công việc của tôi là giúp các bạn nhỏ viết nên những nét chữ đầu tiên. Tôi cùng các bạn tập viết, làm toán, vẽ tranh. Tôi rất vui vì đã góp phần vào việc học tập của các bạn." },
    { id: 16, title: "Bài 16: Cầu vồng", content: "Sau cơn mưa rào, mặt trời ló rạng. Phía đông, một chiếc cầu vồng khổng lồ hiện ra. Cầu vồng có đủ bảy màu: đỏ, cam, vàng, lục, lam, chàm, tím. Hai đầu cầu vồng cắm xuống hai bên bờ sông. Cầu vồng đẹp như một dải lụa mềm mại vắt ngang bầu trời. Một lát sau, cầu vồng nhạt dần rồi biến mất." },
    { id: 17, title: "Bài 17: Trăng", content: "Đêm nay, trăng sáng quá! Trăng tròn vành vạnh, treo lơ lửng trên nền trời đen thẫm. Ánh trăng vàng dịu dàng tỏa xuống khắp nơi. Dưới ánh trăng, mọi vật đều trở nên lung linh, huyền ảo. Em và các bạn rủ nhau ra sân chơi. Chúng em chơi rồng rắn lên mây, vừa chơi vừa hát vang." },
    { id: 18, title: "Bài 18: Bác Hồ của em", content: "Bác Hồ là vị lãnh tụ vĩ đại của dân tộc Việt Nam. Bác đã dành cả cuộc đời mình để đấu tranh cho độc lập, tự do của Tổ quốc. Bác rất yêu thương các cháu thiếu niên, nhi đồng. Bác luôn khuyên chúng em phải chăm học, chăm làm, biết yêu thương, giúp đỡ mọi người. Em luôn ghi nhớ lời Bác dạy và hứa sẽ cố gắng học tập thật tốt để trở thành người có ích cho xã hội." },
    { id: 19, title: "Bài 19: Con trâu", content: "Con trâu là một loài vật rất quen thuộc với người nông dân Việt Nam. Trâu có thân hình vạm vỡ, da đen bóng. Đôi sừng cong vút, trông rất oai vệ. Trâu giúp người nông dân cày bừa, kéo xe. Trâu ăn cỏ, rất hiền lành. Trâu đúng là người bạn thân thiết của nhà nông." },
    { id: 20, title: "Bài 20: Tết Trung Thu", content: "Rằm tháng Tám là Tết Trung Thu. Vào ngày này, trẻ em được người lớn tặng quà, thường là đèn ông sao, mặt nạ, trống... Buổi tối, các em cùng nhau rước đèn, phá cỗ. Cỗ Trung Thu có bánh nướng, bánh dẻo, và nhiều loại hoa quả khác. Em rất thích Tết Trung Thu." },
    { id: 21, title: "Bài 21: Gia đình em", content: "Gia đình em gồm có bố, mẹ và em. Bố em là bộ đội. Mẹ em là giáo viên. Em là học sinh lớp Hai. Cả nhà em đều rất yêu thương nhau. Bố mẹ luôn chăm sóc, dạy dỗ em nên người. Em rất yêu gia đình của em." },
    { id: 22, title: "Bài 22: Cô giáo của em", content: "Cô giáo lớp Hai của em tên là Mai. Cô có mái tóc dài, đen mượt và nụ cười rất hiền. Cô dạy chúng em những bài học hay, những điều tốt đẹp. Cô quan tâm đến tất cả học sinh trong lớp. Bạn nào có hoàn cảnh khó khăn, cô đều tìm cách giúp đỡ. Em rất yêu quý và kính trọng cô giáo của em." },
    { id: 23, title: "Bài 23: Cái đồng hồ", content: "Nhà em có một chiếc đồng hồ treo tường. Vỏ đồng hồ làm bằng gỗ, màu nâu sậm. Mặt đồng hồ hình tròn, có ghi các con số từ 1 đến 12. Ba chiếc kim đồng hồ cứ mải miết chạy vòng quanh. Kim giờ chạy chậm nhất. Kim phút chạy nhanh hơn. Nhanh nhất là kim giây. Đồng hồ giúp cả nhà em biết giờ giấc để học tập và làm việc." },
    { id: 24, title: "Bài 24: Con cá vàng", content: "Nhà em có một bể cá cảnh. Trong bể có mấy chú cá vàng. Thân cá thon dài, được phủ một lớp vảy màu vàng óng. Cái đuôi mềm mại, uyển chuyển như một dải lụa. Mỗi khi bơi, đuôi cá lại uốn lượn trông rất đẹp. Em rất thích ngắm nhìn những chú cá vàng bơi lội." },
    { id: 25, title: "Bài 25: Hoa hồng", content: "Trong vườn nhà em có trồng mấy khóm hoa hồng. Hoa hồng có nhiều màu: hồng, đỏ, trắng. Mỗi bông hoa đều có nhiều lớp cánh mỏng manh, mịn màng xếp chồng lên nhau. Hương hoa hồng thơm ngào ngạt. Hoa hồng thường được dùng để trang trí và làm quà tặng." },
    { id: 26, title: "Bài 26: Quyển sách", content: "Em có một quyển sách Tiếng Việt mới. Bìa sách được trang trí bằng một bức tranh rất đẹp. Trong sách có nhiều bài học hay và những câu chuyện thú vị. Sách giúp em biết thêm nhiều điều mới lạ. Em sẽ giữ gìn sách cẩn thận." },
    { id: 27, title: "Bài 27: Xe đạp", content: "Năm nay, em được bố mẹ mua cho một chiếc xe đạp. Xe có màu xanh da trời, là màu em yêu thích. Hằng ngày, em tự đạp xe đến trường. Đi xe đạp vừa vui, vừa rèn luyện sức khỏe. Em rất thích chiếc xe đạp của em." },
    { id: 28, title: "Bài 28: Mèo con", content: "Nhà em có một chú mèo con rất đáng yêu. Chú có bộ lông màu tam thể, mềm như nhung. Đôi mắt tròn, xanh biếc. Cái đuôi dài, lúc nào cũng ngoe nguẩy. Mèo con rất thích chơi đùa với cuộn len. Chú còn là một tay bắt chuột cừ khôi." },
    { id: 29, title: "Bài 29: Mặt trời", content: "Buổi sáng, ông mặt trời từ từ nhô lên sau rặng tre. Ông tỏa những tia nắng ấm áp xuống khắp nơi, đánh thức vạn vật. Cây cối, hoa lá bừng tỉnh sau một giấc ngủ dài. Mọi người bắt đầu một ngày làm việc mới. Em cũng tung tăng cắp sách đến trường." },
    { id: 30, title: "Bài 30: Đôi bàn tay", content: "Đôi bàn tay của em tuy nhỏ bé nhưng có thể làm được rất nhiều việc. Tay giúp em cầm bút viết bài. Tay giúp em cầm thìa xúc cơm. Tay giúp em làm việc nhà giúp đỡ bố mẹ. Em luôn giữ cho đôi bàn tay của mình sạch sẽ." },
    { id: 31, title: "Bài 31: Ngôi sao", content: "Trên bầu trời đêm, có vô vàn những ngôi sao lấp lánh. Những ngôi sao ở rất xa Trái Đất. Chúng giống như những viên kim cương nhỏ bé, được ai đó rắc lên tấm thảm nhung đen khổng lồ. Em rất thích ngắm nhìn những ngôi sao." },
    { id: 32, title: "Bài 32: Con đường", content: "Con đường dẫn vào làng em được lát bê tông phẳng lì. Hai bên đường là hai hàng cây xanh mát. Dưới bóng cây, chúng em thường chơi bắn bi, nhảy dây. Con đường đã gắn bó với em từ thuở ấu thơ. Dù đi đâu xa, em cũng sẽ không bao giờ quên hình ảnh con đường làng thân thương." },
    { id: 33, title: "Bài 33: Tình bạn", content: "Sơn và Tuấn là đôi bạn thân. Một hôm, Sơn vô ý làm hỏng chiếc bút máy của Tuấn. Sơn rất ân hận và đã xin lỗi bạn. Tuấn không những không giận mà còn an ủi Sơn. Tình bạn của họ thật đáng quý." },
    { id: 34, title: "Bài 34: Cây dừa", content: "Cây dừa xanh toả nhiều tàu\nDang tay đón gió, gật đầu gọi trăng\nThân dừa bạc phếch tháng năm\nQuả dừa – đàn lợn con nằm trên cao.\n\nĐêm hè hoa nở cùng sao\nTàu dừa – chiếc lược chải vào mây xanh\nAi mang nước ngọt, nước lành\nAi đeo bao hũ rượu quanh cổ dừa." },
    { id: 35, title: "Bài 35: Lời cảm ơn", content: "Khi nhận được sự giúp đỡ từ người khác, chúng ta nên nói lời cảm ơn. Khi mắc lỗi, chúng ta nên nói lời xin lỗi. Đó là những biểu hiện của một người lịch sự, văn minh. Em luôn ghi nhớ điều đó." },
];
// --- END OF constants.ts ---


// --- START OF services/geminiService.ts ---

const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });

const schema = {
    type: Type.OBJECT,
    properties: {
        docDayDu: { type: Type.BOOLEAN, description: "Học sinh có đọc hết hoặc gần hết bài không? (true nếu đọc trên 80% bài, false nếu ngược lại)" },
        tongDiem: { type: Type.NUMBER, description: "Tổng điểm đánh giá trên thang 100" },
        doLuuLoat: { type: Type.NUMBER, description: "Điểm lưu loát trên thang 100" },
        phatAm: { type: Type.NUMBER, description: "Điểm phát âm trên thang 100" },
        doChinhXac: { type: Type.NUMBER, description: "Điểm chính xác (đọc đúng chữ) trên thang 100" },
        nhanXetChung: { type: Type.STRING, description: "Nhận xét chung ngắn gọn về bài đọc của học sinh" },
        tuPhatAmSai: {
            type: Type.ARRAY,
            description: "Danh sách các từ học sinh phát âm sai. Ghi lại từ học sinh đọc sai dựa trên âm thanh nghe được.",
            items: {
                type: Type.OBJECT,
                properties: {
                    tu: { type: Type.STRING, description: "Từ gốc trong văn bản" },
                    phatAmSai: { type: Type.STRING, description: "Từ mà học sinh đã phát âm sai (dựa trên audio)" },
                    suaLai: { type: Type.STRING, description: "Cách phát âm đúng" },
                },
                required: ["tu", "phatAmSai", "suaLai"],
            },
        },
        diemTichCuc: {
            type: Type.ARRAY,
            description: "Danh sách những điểm tích cực, lời khen dành cho học sinh",
            items: { type: Type.STRING },
        },
    },
    required: ["docDayDu", "tongDiem", "doLuuLoat", "phatAm", "doChinhXac", "nhanXetChung", "tuPhatAmSai", "diemTichCuc"],
};


async function evaluateReading(passageText, audioBase64, mimeType) {
    try {
        const prompt = `Bạn là một giám khảo chấm thi đọc Tiếng Việt cho học sinh lớp 2, yêu cầu sự chính xác và nghiêm khắc.
        Nhiệm vụ của bạn là đánh giá khả năng đọc của một học sinh dựa trên đoạn văn gốc và file ghi âm.
        
        QUY TẮC BẮT BUỘC:
        1.  **Kiểm tra độ đầy đủ:** Đầu tiên, xác định học sinh có đọc hết bài không. Nếu học sinh chỉ đọc dưới 80% bài, hãy đặt "docDayDu" thành false, cho tất cả các điểm thành 0, và đặt "nhanXetChung" là "Em chưa đọc hết bài. Vui lòng đọc lại toàn bộ bài để được chấm điểm nhé.". Trong trường hợp này, không cần nhận xét gì thêm và trả về các mảng rỗng.
        2.  **Chấm điểm nghiêm ngặt (nếu đọc đủ bài):** Nếu "docDayDu" là true, hãy chấm điểm theo thang điểm 100 với các tiêu chí sau:
            - **Độ chính xác (tối đa 40 điểm):** Đây là phần quan trọng nhất. Mỗi lỗi đọc sai từ, thiếu từ, hoặc thừa từ so với văn bản gốc, trừ 2 điểm.
            - **Phát âm (tối đa 30 điểm):** Đánh giá sự tròn vành, rõ chữ. Trừ điểm nặng cho các lỗi phát âm phổ biến (l/n, s/x, tr/ch, r/d/gi, dấu hỏi/ngã). Mỗi lỗi trừ 1-2 điểm tùy mức độ.
            - **Độ lưu loát (tối đa 30 điểm):** Đánh giá tốc độ đọc phù hợp (khoảng 50-70 từ/phút), và việc ngắt nghỉ đúng ở dấu câu. Mỗi lần đọc vấp, ngập ngừng, lặp lại từ, trừ 1 điểm.
        3.  **Nhận xét:** Đưa ra nhận xét cụ thể. Với mỗi từ sai, hãy xác định chính xác học sinh đã đọc sai thành gì và điền vào trường "phatAmSai". Ví dụ, nếu từ gốc là "nói" và học sinh đọc là "lói", thì "tu" là "nói", "phatAmSai" là "lói", và "suaLai" là "nói".
        
        Đoạn văn gốc: "${passageText}"
        
        Hãy phân tích file ghi âm và trả về kết quả dưới dạng JSON theo schema đã cung cấp.`;

        const audioPart = {
            inlineData: {
                data: audioBase64,
                mimeType: mimeType,
            },
        };
        
        const response = await ai.models.generateContent({
            model: 'gemini-2.5-flash',
            contents: { parts: [{ text: prompt }, audioPart] },
            config: {
                responseMimeType: "application/json",
                responseSchema: schema,
            },
        });
        
        const jsonText = response.text.trim();
        const result = JSON.parse(jsonText);
        return result;

    } catch (error) {
        console.error("Error evaluating reading:", error);
        throw new Error("Không thể phân tích bài đọc. Vui lòng thử lại.");
    }
}

async function generateSpeech(text) {
    try {
        const instructedText = `Đọc: ${text}`;

        const response = await ai.models.generateContent({
            model: "gemini-2.5-flash-preview-tts",
            contents: [{ parts: [{ text: instructedText }] }],
            config: {
                responseModalities: [Modality.AUDIO],
                speechConfig: {
                    voiceConfig: {
                        prebuiltVoiceConfig: { voiceName: 'Kore' },
                    },
                },
            },
        });

        const audioPart = response.candidates?.[0]?.content?.parts?.find(p => p.inlineData);
        const base64Audio = audioPart?.inlineData?.data;

        if (!base64Audio) {
            console.error("TTS API did not return audio data. Response:", JSON.stringify(response, null, 2));
            throw new Error("Không nhận được dữ liệu âm thanh từ API.");
        }
        return base64Audio;
    } catch (error) {
        console.error("Error generating speech:", error);
        throw new Error("Không thể tạo giọng đọc mẫu. Vui lòng thử lại.");
    }
}
// --- END OF services/geminiService.ts ---


// --- START OF services/sheetService.ts ---

const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxaIW0K7t_0Nm5qA5_gycFydDoLWvlaItwk3obV7hjr7Hqx37luVBX7Y-SlsGbYgoRYRw/exec';

async function saveEvaluationToSheet(
  studentInfo,
  passage,
  result
) {
    if (!APPS_SCRIPT_URL) {
        console.warn('URL Google Apps Script chưa được cấu hình. Bỏ qua việc lưu vào Sheet.');
        throw new Error('URL_NOT_CONFIGURED');
    }

    const formData = new FormData();
    formData.append('name', studentInfo.name);
    formData.append('class', studentInfo.class);
    formData.append('passageTitle', passage.title);
    formData.append('totalScore', result.tongDiem.toString());
    formData.append('fluency', result.doLuuLoat.toString());
    formData.append('pronunciation', result.phatAm.toString());
    formData.append('accuracy', result.doChinhXac.toString());
    formData.append('generalFeedback', result.nhanXetChung);
    formData.append('positivePoints', result.diemTichCuc.join('; '));
    formData.append('wordsToImprove', result.tuPhatAmSai.map(w => `${w.tu} -> ${w.suaLai}`).join('; '));

    try {
        const response = await fetch(APPS_SCRIPT_URL, {
            method: 'POST',
            body: formData,
        });

        const responseData = await response.json();

        if (responseData.result !== 'success') {
            throw new Error(responseData.message || 'Lỗi không xác định từ Apps Script');
        }
    } catch (error) {
        console.error("Lỗi khi lưu vào Google Sheet:", error);
        throw new Error("Không thể lưu kết quả vào Google Sheet.");
    }
}
// --- END OF services/sheetService.ts ---


// --- START OF hooks/useAudioRecorder.ts ---

function useAudioRecorder() {
  const [isRecording, setIsRecording] = useState(false);
  const [error, setError] = useState(null);
  const mediaRecorderRef = useRef(null);
  const audioChunksRef = useRef([]);

  const startRecording = useCallback(async () => {
    setError(null);
    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const mediaRecorder = new MediaRecorder(stream);
        mediaRecorderRef.current = mediaRecorder;
        
        mediaRecorder.ondataavailable = (event) => {
          audioChunksRef.current.push(event.data);
        };
        
        mediaRecorder.onstart = () => {
          setIsRecording(true);
          audioChunksRef.current = [];
        };

        mediaRecorder.start();

      } catch (err) {
        console.error("Error accessing microphone:", err);
        setError("Không thể truy cập micro. Vui lòng cấp quyền sử dụng micro trong trình duyệt.");
      }
    } else {
      setError("Trình duyệt không hỗ trợ ghi âm.");
    }
  }, []);

  const stopRecording = useCallback(() => {
    return new Promise((resolve, reject) => {
      if (mediaRecorderRef.current && isRecording) {
        mediaRecorderRef.current.onstop = () => {
          const mimeType = mediaRecorderRef.current?.mimeType || 'audio/webm';
          const audioBlob = new Blob(audioChunksRef.current, { type: mimeType });
          const reader = new FileReader();
          reader.readAsDataURL(audioBlob);
          reader.onloadend = () => {
            const base64String = (reader.result).split(',')[1];
            resolve({ audioBase64: base64String, mimeType });
          };
          reader.onerror = (error) => {
              reject(error);
          };
          setIsRecording(false);
          mediaRecorderRef.current?.stream.getTracks().forEach(track => track.stop());
        };
        mediaRecorderRef.current.stop();
      } else {
        reject(new Error("Không có quá trình ghi âm nào đang diễn ra."));
      }
    });
  }, [isRecording]);

  return { isRecording, startRecording, stopRecording, error };
}
// --- END OF hooks/useAudioRecorder.ts ---


// --- START OF hooks/useAudioPlayer.ts ---

function decode(base64) {
  const binaryString = atob(base64);
  const len = binaryString.length;
  const bytes = new Uint8Array(len);
  for (let i = 0; i < len; i++) {
    bytes[i] = binaryString.charCodeAt(i);
  }
  return bytes;
}

async function decodeAudioData(
  data,
  ctx,
) {
  const sampleRate = 24000;
  const numChannels = 1;
  
  const dataInt16 = new Int16Array(data.buffer);
  const frameCount = dataInt16.length / numChannels;
  const buffer = ctx.createBuffer(numChannels, frameCount, sampleRate);

  for (let channel = 0; channel < numChannels; channel++) {
    const channelData = buffer.getChannelData(channel);
    for (let i = 0; i < frameCount; i++) {
      channelData[i] = dataInt16[i * numChannels + channel] / 32768.0;
    }
  }
  return buffer;
}

function useAudioPlayer() {
  const [isPlaying, setIsPlaying] = useState(false);
  const audioContextRef = useRef(null);
  const audioSourceRef = useRef(null);

  const stopAudio = useCallback(() => {
    if (audioSourceRef.current) {
      try {
        audioSourceRef.current.stop();
      } catch (e) {
        // Ignore error if already stopped
      }
      audioSourceRef.current = null;
    }
    setIsPlaying(false);
  }, []);
  
  const playAudio = useCallback(async (base64Audio) => {
    stopAudio(); 

    if (!audioContextRef.current || audioContextRef.current.state === 'closed') {
      audioContextRef.current = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 24000 });
    }
    
    const audioContext = audioContextRef.current;
    
    try {
      setIsPlaying(true);
      const decodedBytes = decode(base64Audio);
      const audioBuffer = await decodeAudioData(decodedBytes, audioContext);
      
      const source = audioContext.createBufferSource();
      source.buffer = audioBuffer;
      source.connect(audioContext.destination);
      source.onended = () => {
        setIsPlaying(false);
        audioSourceRef.current = null;
      };
      source.start(0);
      audioSourceRef.current = source;
    } catch (error) {
        console.error("Failed to play audio:", error);
        setIsPlaying(false);
        throw new Error("Không thể phát âm thanh.");
    }
  }, [stopAudio]);

  useEffect(() => {
    return () => {
      stopAudio();
      if (audioContextRef.current && audioContextRef.current.state !== 'closed') {
        audioContextRef.current.close();
      }
    };
  }, [stopAudio]);

  return { isPlaying, playAudio, stopAudio };
}
// --- END OF hooks/useAudioPlayer.ts ---


// --- START OF components/Spinner.tsx ---
function Spinner({ message }) {
  return (
    React.createElement('div', { className: "flex flex-col items-center justify-center min-h-screen bg-blue-100/50" },
        React.createElement('div', { className: "w-16 h-16 border-8 border-dashed rounded-full animate-spin border-blue-600" }),
        React.createElement('p', { className: "text-blue-800 text-xl font-semibold mt-6" }, message)
    )
  );
}
// --- END OF components/Spinner.tsx ---


// --- START OF components/WelcomeScreen.tsx ---
function WelcomeScreen({ onStart }) {
  const [name, setName] = useState('');
  const [studentClass, setStudentClass] = useState('');

  const handleSubmit = (e) => {
    e.preventDefault();
    if (name.trim() && studentClass.trim()) {
      onStart({ name, class: studentClass });
    }
  };

  return (
    React.createElement('div', { className: "flex flex-col items-center justify-center min-h-screen bg-gradient-to-b from-blue-100 to-blue-200 p-4" },
      React.createElement('div', { className: "w-full max-w-md bg-white rounded-2xl shadow-lg p-8 text-center" },
        React.createElement('h1', { className: "text-4xl font-bold text-blue-800 mb-2" }, "Luyện đọc Lớp 2"),
        React.createElement('p', { className: "text-gray-600 mb-8" }, "Cùng AI cải thiện kỹ năng đọc nhé!"),
        React.createElement('form', { onSubmit: handleSubmit, className: "space-y-6" },
          React.createElement('div', null,
            React.createElement('input', {
              type: "text",
              placeholder: "Họ và tên của em",
              value: name,
              onChange: (e) => setName(e.target.value),
              className: "w-full px-4 py-3 text-lg border-2 border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition",
              required: true
            })
          ),
          React.createElement('div', null,
            React.createElement('input', {
              type: "text",
              placeholder: "Lớp",
              value: studentClass,
              onChange: (e) => setStudentClass(e.target.value),
              className: "w-full px-4 py-3 text-lg border-2 border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition",
              required: true
            })
          ),
          React.createElement('button', {
            type: "submit",
            className: "w-full bg-blue-600 text-white font-bold py-4 text-xl rounded-lg hover:bg-blue-700 transition-transform transform hover:scale-105 shadow-md disabled:bg-gray-400",
            disabled: !name.trim() || !studentClass.trim()
          }, "Bắt đầu")
        )
      )
    )
  );
}
// --- END OF components/WelcomeScreen.tsx ---


// --- START OF components/PassageList.tsx ---
function PassageList({ studentInfo, onSelectPassage, onBackToWelcome }) {
  return (
    React.createElement('div', { className: "min-h-screen bg-blue-50 p-4 sm:p-8" },
      React.createElement('div', { className: "max-w-4xl mx-auto" },
        React.createElement('header', { className: "mb-8 p-4 bg-white rounded-xl shadow flex justify-between items-center" },
            React.createElement('div', null,
              React.createElement('h1', { className: "text-3xl font-bold text-blue-800" }, `Chào ${studentInfo.name}!`),
              React.createElement('p', { className: "text-gray-600" }, "Hãy chọn một bài để bắt đầu luyện đọc nhé.")
            ),
            React.createElement('button', { onClick: onBackToWelcome, className: "text-sm text-gray-600 hover:text-blue-700 hover:underline" },
                React.createElement('i', { className: "fas fa-user-edit mr-1" }),
                "Đổi học sinh"
            )
        ),
        React.createElement('div', { className: "grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6" },
          READING_PASSAGES.map((passage) => (
            React.createElement('button', {
              key: passage.id,
              onClick: () => onSelectPassage(passage),
              className: "bg-white p-6 rounded-lg shadow-md hover:shadow-lg hover:bg-blue-100 transition-all text-left transform hover:-translate-y-1"
            },
              React.createElement('h2', { className: "text-xl font-bold text-blue-700" }, passage.title),
              React.createElement('p', { className: "text-gray-500 mt-2 line-clamp-3" }, passage.content)
            )
          ))
        )
      )
    )
  );
}
// --- END OF components/PassageList.tsx ---


// --- START OF components/ReadingView.tsx ---
function ReadingView({ passage, onBack, onFinishRecording, error: appError }) {
  const { isRecording, startRecording, stopRecording, error: recorderError } = useAudioRecorder();
  const { isPlaying: isSamplePlaying, playAudio: playSampleAudio, stopAudio: stopSampleAudio } = useAudioPlayer();
  const [isGeneratingSpeech, setIsGeneratingSpeech] = useState(false);
  const [ttsError, setTtsError] = useState(null);

  const handleListenSample = async () => {
    if (isGeneratingSpeech || isRecording) return;
    
    stopSampleAudio();

    setIsGeneratingSpeech(true);
    setTtsError(null);

    try {
        const audioBase64 = await generateSpeech(passage.content);
        await playSampleAudio(audioBase64);
    } catch (err) {
        setTtsError(err instanceof Error ? err.message : "Lỗi không xác định khi tạo giọng đọc mẫu.");
    } finally {
        setIsGeneratingSpeech(false);
    }
  };

  const handleStart = async () => {
    stopSampleAudio();
    await startRecording();
  };

  const handleStop = async () => {
    try {
      const audio = await stopRecording();
      onFinishRecording(audio);
    } catch (err) {
      console.error("Error finishing recording:", err);
    }
  };
  
  const isBusy = isGeneratingSpeech || isSamplePlaying;
  const combinedError = appError || recorderError || ttsError;

  return (
    React.createElement('div', { className: "flex flex-col items-center justify-center min-h-screen bg-blue-100 p-4" },
      React.createElement('div', { className: "w-full max-w-2xl bg-white rounded-2xl shadow-xl p-8" },
        React.createElement('div', { className: "flex justify-between items-center mb-6" },
          React.createElement('h1', { className: "text-3xl font-bold text-blue-800" }, passage.title),
          React.createElement('button', { onClick: onBack, className: "text-gray-500 hover:text-gray-800" },
            React.createElement('i', { className: "fas fa-arrow-left mr-2" }), " Quay lại"
          )
        ),
        React.createElement('div', { className: "bg-gray-50 p-6 rounded-lg text-lg leading-relaxed text-gray-800 mb-8 h-64 overflow-y-auto whitespace-pre-line" },
          passage.content
        ),
        
        combinedError && React.createElement('p', { className: "text-red-500 text-center mb-4" }, combinedError),
        
        React.createElement('div', { className: "flex flex-col items-center" },
          !isRecording ? (
             React.createElement('div', { className: "flex items-center justify-center space-x-4" },
              React.createElement('button', {
                onClick: handleListenSample,
                disabled: isBusy,
                className: "flex items-center justify-center w-40 h-16 bg-blue-500 text-white font-bold text-lg rounded-full shadow-lg hover:bg-blue-600 transition transform hover:scale-105 disabled:bg-gray-400 disabled:cursor-not-allowed"
              },
                isGeneratingSpeech ? React.createElement('i', { className: "fas fa-spinner fa-spin" }) : (isSamplePlaying ? React.createElement('i', { className: "fas fa-wave-square animate-pulse" }) : React.createElement(React.Fragment, null, React.createElement('i', { className: "fas fa-volume-up mr-2" }), " Nghe mẫu"))
              ),
              React.createElement('button', {
                onClick: handleStart,
                disabled: isBusy,
                className: "flex items-center justify-center w-48 h-16 bg-green-500 text-white font-bold text-lg rounded-full shadow-lg hover:bg-green-600 transition transform hover:scale-105 disabled:bg-gray-400 disabled:cursor-not-allowed"
              },
                React.createElement('i', { className: "fas fa-microphone mr-3" }),
                "Bắt đầu đọc"
              )
            )
          ) : (
            React.createElement('button', {
              onClick: handleStop,
              className: "flex items-center justify-center w-48 h-16 bg-red-500 text-white font-bold text-xl rounded-full shadow-lg hover:bg-red-600 transition transform hover:scale-105 animate-pulse"
            },
              React.createElement('i', { className: "fas fa-stop mr-3" }),
              "Nộp bài"
            )
          ),
           React.createElement('p', { className: "text-gray-500 mt-4 h-5 text-center" },
            isGeneratingSpeech && "AI đang chuẩn bị giọng đọc mẫu...",
            isSamplePlaying && "Đang phát bài đọc mẫu...",
            !isGeneratingSpeech && !isSamplePlaying && (isRecording ? "AI đang lắng nghe... Hãy đọc to và rõ ràng nhé!" : "Nhấn 'Nghe mẫu' hoặc 'Bắt đầu đọc'.")
           )
        )
      )
    )
  );
}
// --- END OF components/ReadingView.tsx ---


// --- START OF components/EvaluationView.tsx ---
const ScoreBar = ({ label, score, color }) => (
  React.createElement('div', null,
    React.createElement('div', { className: "flex justify-between items-center mb-1" },
      React.createElement('span', { className: "font-semibold text-gray-700" }, label),
      React.createElement('span', { className: `font-bold ${color}` }, `${score}/100`)
    ),
    React.createElement('div', { className: "w-full bg-gray-200 rounded-full h-4" },
      React.createElement('div', {
        className: `bg-gradient-to-r ${color === 'text-blue-500' ? 'from-blue-400 to-blue-600' : color === 'text-green-500' ? 'from-green-400 to-green-600' : color === 'text-purple-500' ? 'from-purple-400 to-purple-600' : 'from-yellow-400 to-yellow-600'} h-4 rounded-full`,
        style: { width: `${score}%` }
      })
    )
  )
);

const SheetSaveStatusIndicator = ({ status }) => {
    if (status === 'idle') return null;

    if (status === 'saving') {
        return (
            React.createElement('div', { className: "flex items-center text-gray-600" },
                React.createElement('i', { className: "fas fa-spinner fa-spin mr-2" }),
                React.createElement('span', null, "Đang lưu kết quả vào Google Sheet...")
            )
        );
    }

    if (status === 'success') {
        return (
            React.createElement('div', { className: "flex items-center text-green-600" },
                React.createElement('i', { className: "fas fa-check-circle mr-2" }),
                React.createElement('span', null, "Đã lưu kết quả thành công!")
            )
        );
    }

    if (status === 'error') {
        return (
            React.createElement('div', { className: "flex items-center text-red-600" },
                React.createElement('i', { className: "fas fa-exclamation-triangle mr-2" }),
                React.createElement('span', null, "Lưu kết quả thất bại. Vui lòng thử lại sau.")
            )
        );
    }
    return null;
};

function EvaluationView({ result, studentInfo, passage, onChooseAnotherPassage, onReadAgain, sheetSaveStatus }) {
    const { playAudio, isPlaying } = useAudioPlayer();
    const [loadingWord, setLoadingWord] = useState(null);

    const handlePlayWord = async (word) => {
        if (loadingWord || isPlaying) return; 
        
        setLoadingWord(word);
        try {
            const audioBase64 = await generateSpeech(word);
            await playAudio(audioBase64);
        } catch (error) {
            console.error("Failed to generate speech for word:", error);
        } finally {
            setLoadingWord(null);
        }
    };

    if (!result.docDayDu) {
        return (
            React.createElement('div', { className: "flex flex-col items-center justify-center min-h-screen bg-yellow-50 p-4 text-center" },
                React.createElement('div', { className: "w-full max-w-lg bg-white rounded-2xl shadow-xl p-8" },
                    React.createElement('i', { className: "fas fa-book-reader text-5xl text-yellow-500 mb-4" }),
                    React.createElement('h1', { className: "text-2xl font-bold text-gray-800 mb-4" }, "Em ơi, cố gắng lên nhé!"),
                    React.createElement('p', { className: "text-gray-600 text-lg mb-8" }, result.nhanXetChung),
                    React.createElement('button', {
                        onClick: onReadAgain,
                        className: "bg-blue-600 text-white font-bold py-3 px-8 text-lg rounded-lg hover:bg-blue-700 transition-transform transform hover:scale-105"
                    },
                        "Đọc lại bài này"
                    )
                )
            )
        );
    }


  return (
    React.createElement('div', { className: "min-h-screen bg-blue-50 p-4 sm:p-8" },
      React.createElement('div', { className: "max-w-4xl mx-auto bg-white rounded-2xl shadow-xl p-6 sm:p-8" },
        React.createElement('header', { className: "text-center border-b pb-6 mb-6" },
          React.createElement('h1', { className: "text-4xl font-extrabold text-blue-800" }, "Kết quả luyện đọc"),
          React.createElement('p', { className: "text-lg text-gray-600 mt-2" },
            "Bài: ", React.createElement('span', { className: "font-semibold" }, passage.title), " | Học sinh: ", React.createElement('span', { className: "font-semibold" }, studentInfo.name), " - Lớp: ", React.createElement('span', { className: "font-semibold" }, studentInfo.class)
          )
        ),

        React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-2 gap-8" },
          React.createElement('div', { className: "space-y-6" },
            React.createElement('div', null,
              React.createElement('h2', { className: "text-2xl font-bold text-gray-800 mb-4" }, "Điểm số của em"),
              React.createElement('div', { className: "flex items-center justify-center bg-blue-100 rounded-full w-40 h-40 mx-auto border-8 border-blue-200" },
                React.createElement('span', { className: "text-5xl font-bold text-blue-700" }, result.tongDiem)
              )
            ),
            React.createElement('div', { className: "space-y-4" },
              React.createElement(ScoreBar, { label: "Độ lưu loát", score: result.doLuuLoat, color: "text-blue-500" }),
              React.createElement(ScoreBar, { label: "Phát âm", score: result.phatAm, color: "text-green-500" }),
              React.createElement(ScoreBar, { label: "Độ chính xác", score: result.doChinhXac, color: "text-purple-500" })
            )
          ),

          React.createElement('div', { className: "space-y-6" },
            React.createElement('div', null,
              React.createElement('h3', { className: "text-xl font-bold text-gray-800 mb-3" },
                React.createElement('i', { className: "fas fa-comment-dots mr-2 text-blue-500" }),
                "Nhận xét của AI"
              ),
              React.createElement('p', { className: "bg-blue-50 p-4 rounded-lg text-gray-700 italic" }, `"${result.nhanXetChung}"`)
            ),
            React.createElement('div', null,
              React.createElement('h3', { className: "text-xl font-bold text-gray-800 mb-3" },
                React.createElement('i', { className: "fas fa-star mr-2 text-yellow-500" }),
                "Những điểm em làm tốt"
              ),
              React.createElement('ul', { className: "list-disc list-inside space-y-1 text-green-700" },
                result.diemTichCuc.map((point, index) => (
                  React.createElement('li', { key: index }, point)
                ))
              )
            )
          )
        ),

        React.createElement('div', { className: "mt-8 border-t pt-6" },
            React.createElement('h3', { className: "text-2xl font-bold text-center text-gray-800 mb-4" },
               "Những từ cần luyện tập thêm"
            ),
            result.tuPhatAmSai.length > 0 ? (
                React.createElement('div', { className: "max-w-md mx-auto" },
                    React.createElement('ul', { className: "space-y-3" },
                        result.tuPhatAmSai.map((word, index) => (
                            React.createElement('li', { key: index, className: "bg-yellow-50 p-3 rounded-lg flex items-center justify-between shadow-sm" },
                                React.createElement('div', { className: "text-left" },
                                    React.createElement('span', { className: "text-gray-500 text-sm" }, "Em đọc"),
                                    React.createElement('p', { className: "font-bold text-lg text-red-600 line-through" }, word.phatAmSai)
                                ),
                                React.createElement('i', { className: "fas fa-long-arrow-alt-right text-gray-400 text-2xl mx-2" }),
                                React.createElement('div', { className: "text-right flex items-center gap-2" },
                                     React.createElement('div', { className: "flex-grow" },
                                        React.createElement('span', { className: "text-gray-500 text-sm" }, "Đọc đúng là"),
                                        React.createElement('p', { className: "font-bold text-lg text-green-600" }, word.tu)
                                     ),
                                      React.createElement('button', {
                                        onClick: () => handlePlayWord(word.tu),
                                        disabled: !!loadingWord || isPlaying,
                                        className: "w-10 h-10 flex-shrink-0 flex items-center justify-center rounded-full bg-blue-100 text-blue-600 hover:bg-blue-200 disabled:bg-gray-200 disabled:text-gray-400 disabled:cursor-not-allowed transition",
                                        "aria-label": `Nghe từ ${word.tu}`
                                      },
                                        loadingWord === word.tu ? (
                                          React.createElement('i', { className: "fas fa-spinner fa-spin" })
                                        ) : (
                                          React.createElement('i', { className: "fas fa-volume-up" })
                                        )
                                      )
                                )
                            )
                        ))
                    )
                )
            ) : (
                React.createElement('div', { className: "text-center bg-green-50 p-4 rounded-lg" },
                    React.createElement('i', { className: "fas fa-check-circle text-green-500 text-2xl mb-2" }),
                    React.createElement('p', { className: "text-green-700 font-semibold" }, "Tuyệt vời! Em đã đọc rất tốt, không có từ nào phát âm sai!")
                )
            )
        ),


        React.createElement('footer', { className: "mt-8 pt-6 border-t flex flex-col sm:flex-row justify-between items-center gap-4" },
          React.createElement(SheetSaveStatusIndicator, { status: sheetSaveStatus }),
           React.createElement('div', { className: "flex flex-col sm:flex-row gap-4 w-full sm:w-auto ml-auto" },
              React.createElement('button', {
                onClick: onReadAgain,
                className: "w-full sm:w-auto bg-green-600 text-white font-bold py-3 px-6 text-lg rounded-lg hover:bg-green-700 transition-transform transform hover:scale-105 shadow-md"
              },
                "Đọc lại bài này"
              ),
              React.createElement('button', {
                onClick: onChooseAnotherPassage,
                className: "w-full sm:w-auto bg-blue-600 text-white font-bold py-3 px-6 text-lg rounded-lg hover:bg-blue-700 transition-transform transform hover:scale-105 shadow-md"
              },
                "Chọn bài đọc khác"
              )
          )
        )
      )
    )
  );
}
// --- END OF components/EvaluationView.tsx ---


// --- START OF App.tsx ---
function App() {
  const [page, setPage] = useState('welcome');
  const [studentInfo, setStudentInfo] = useState(null);
  const [selectedPassage, setSelectedPassage] = useState(null);
  const [evaluationResult, setEvaluationResult] = useState(null);
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState(null);
  const [sheetSaveStatus, setSheetSaveStatus] = useState('idle');
  
  const handleStart = (info) => {
    setStudentInfo(info);
    setPage('passage-list');
  };

  const handleSelectPassage = (passage) => {
    setSelectedPassage(passage);
    setPage('reading');
  };

  const handleFinishRecording = async (audio) => {
    if (!selectedPassage || !studentInfo) return;
    setIsLoading(true);
    setError(null);
    setSheetSaveStatus('idle');

    try {
      const result = await evaluateReading(selectedPassage.content, audio.audioBase64, audio.mimeType);
      setEvaluationResult(result);
      setPage('evaluation');
      
      if (result.docDayDu) {
        setSheetSaveStatus('saving');
        try {
          await saveEvaluationToSheet(studentInfo, selectedPassage, result);
          setSheetSaveStatus('success');
        } catch (sheetError) {
          console.error("Sheet saving failed:", sheetError);
          setSheetSaveStatus('error');
        }
      }

    } catch (err) {
      if (err instanceof Error) {
        setError(err.message);
      } else {
        setError("Đã xảy ra lỗi không xác định.");
      }
      setPage('reading'); 
    } finally {
      setIsLoading(false);
    }
  };

  const handleChooseAnotherPassage = () => {
    setSelectedPassage(null);
    setEvaluationResult(null);
    setError(null);
    setSheetSaveStatus('idle');
    setPage('passage-list');
  };

  const handleReadSamePassageAgain = () => {
    setEvaluationResult(null);
    setError(null);
    setSheetSaveStatus('idle');
    setPage('reading');
  };

  const handleBackToWelcome = () => {
    setStudentInfo(null);
    setSelectedPassage(null);
    setEvaluationResult(null);
    setError(null);
    setSheetSaveStatus('idle');
    setPage('welcome');
  };
  
  const handleBackToPassageList = () => {
    setSelectedPassage(null);
    setError(null);
    setPage('passage-list');
  }
  
  const renderPage = () => {
    if (isLoading) {
      return React.createElement(Spinner, { message: "AI đang chấm bài, em chờ một lát nhé..." });
    }

    switch (page) {
      case 'welcome':
        return React.createElement(WelcomeScreen, { onStart: handleStart });
      case 'passage-list':
        if (studentInfo) {
          return React.createElement(PassageList, { studentInfo: studentInfo, onSelectPassage: handleSelectPassage, onBackToWelcome: handleBackToWelcome });
        }
        return React.createElement(WelcomeScreen, { onStart: handleStart });
      case 'reading':
        if (selectedPassage) {
          return React.createElement(ReadingView, { passage: selectedPassage, onBack: handleBackToPassageList, onFinishRecording: handleFinishRecording, error: error });
        }
        return React.createElement(WelcomeScreen, { onStart: handleStart }); // Fallback
      case 'evaluation':
        if (evaluationResult && studentInfo && selectedPassage) {
          return React.createElement(EvaluationView, { result: evaluationResult, studentInfo: studentInfo, passage: selectedPassage, onChooseAnotherPassage: handleChooseAnotherPassage, onReadAgain: handleReadSamePassageAgain, sheetSaveStatus: sheetSaveStatus });
        }
        return React.createElement(WelcomeScreen, { onStart: handleStart }); // Fallback
      default:
        return React.createElement(WelcomeScreen, { onStart: handleStart });
    }
  };

  return React.createElement('div', { className: "font-sans" }, renderPage());
}
// --- END OF App.tsx ---


// --- START OF index.tsx ---
const rootElement = document.getElementById('root');
if (!rootElement) {
  throw new Error("Could not find root element to mount to");
}

const root = ReactDOM.createRoot(rootElement);
root.render(
  React.createElement(React.StrictMode, null,
    React.createElement(App, null)
  )
);
// --- END OF index.tsx ---
    </script>
  </body>
</html>